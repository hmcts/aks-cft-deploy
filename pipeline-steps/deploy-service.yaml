parameters:
  environment: ''
  location: ''
  stack: ''
  project: ''
  tfversion: ''
  tfvars: ''
  serviceConnection: ''
  tfInitSub: ''
  targetCommand: ''
  builtFrom: ''
  product: ''

steps:

  - template: steps/terraform.yaml@cnp-azuredevops-libraries
    parameters:
      overrideAction: ${{ parameters.action }}
      environment: ${{ parameters.environment }}
      component: ${{ parameters.stack }}
      serviceConnection: ${{ parameters.serviceConnection }}
      terraformInitSubscription: ${{ parameters.tfInitSub }}
      product: ${{ parameters.product }}
      terraformVarFile: "$(System.DefaultWorkingDirectory)/environments/${{ parameters.stack }}/${{ parameters.environment }}.tfvars"
      initCommandOptions: >
        -var subscription_id=$(ARM_SUBSCRIPTION_ID)
        -backend-config resource_group_name=$(backendAzureRmResourceGroupName)
      planCommandOptions: >
        -var subscription_id=$(ARM_SUBSCRIPTION_ID)
        -var control_vault=$(controlKeyVault)
        -var project=$(project) ${{ parameters.targetCommand }}

  - task: TerraformCLI@0
    displayName: Terraform output
    inputs:
      command: output
      terraformVersion: ${{ parameters.tfversion }}
      workingDirectory: $(System.DefaultWorkingDirectory)/components/${{ parameters.stack }}
      environmentServiceName: ${{ parameters.serviceConnection }}

  - script: |
      echo "Setting clusterNumbers variable to $clusters"
      echo "##vso[task.setvariable variable=clusterNumbers;isOutput=true]$clusters"
    name: setClusterNumbers
    env:
      clusters: $(TF_OUT_CLUSTERS)