parameters:
  environment: ''
  project: ''
  akskeyvault: ''

steps:

- template: steps/keyvault-read.yaml@cnp-azuredevops-libraries
  parameters:
    serviceConnection: $(serviceConnection)
    environment: ${{ parameters.environment }}

- task: AzureCLI@1
  displayName: 'Setup Authentication'
  condition: and(variables.isMain, eq(variables['Action'], 'Apply'))
  inputs:
      azureSubscription: $(serviceConnection)
      addSpnToEnvironment: true
      scriptLocation: inlineScript
      failOnStandardError: 'true'
      inlineScript: |   
        echo "##vso[task.setvariable variable=AZURE_MI_ID]$(az identity show --resource-group genesis-rg --name aks-$(env)-mi --query="clientId" -o tsv)"

- task: AzureCLI@1
  displayName: 'Bootstrap'
  condition: and(variables.isMain, true, eq(variables['action'], 'apply'))
  inputs:
    azureSubscription: $(serviceConnection)
    addSpnToEnvironment: true
    scriptType: shell
    failOnStandardError: 'false'
    scriptPath: bootstrap/bootstrap.sh
    arguments: ${{ parameters.project }} aks $(env) $(controlKeyVault) $(serviceConnection) "$(clusters)" deploy ${{ parameters.akskeyvault }} '