parameters:
  environment: ''
  cluster: ''
  location: ''
  stack: ''
  project: ''
  tfInitSub: ''
  targetCommand: ''
  builtFrom: ''
  product: ''
  serviceConnection: ''
  action: ''

steps:
  - template: steps/set-build-repo-suffix-env-var.yaml@cnp-azuredevops-libraries
  - task: AzureCLI@2
    displayName: StopStartAksCluster
    name: StopStartAksCluster
    inputs:
      azureSubscription: $(serviceConnection)
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        CLUSTER_NAME=$(echo cft-${{ parameters.environment }}-${{ parameters.cluster }}-aks | sed -e 's/\(.*\)/\L\1/')
        RESOURCE_GROUP_NAME=$(echo cft-${{ parameters.environment }}-${{ parameters.cluster }}-rg | sed -e 's/\(.*\)/\L\1/')
        echo Cluster name is $CLUSTER_NAME and Resource group name is $RESOURCE_GROUP_NAME

        echo Stopping aks cluster has commenced.
        az aks stop --name $CLUSTER_NAME --resource-group $RESOURCE_GROUP_NAME
        echo $? aks stop status.
        sleep 180
        echo Starting aks cluster has commenced.
        az aks start --name $CLUSTER_NAME --resource-group $RESOURCE_GROUP_NAME
        echo $? aks start status.
        sleep 30
        echo Moving on to the Terraform destroy section.

  - template: steps/terraform.yaml@cnp-azuredevops-libraries
    parameters:
      overrideAction: ${{ parameters.action }}
      environment: ${{ parameters.environment }}
      component: ${{ parameters.component }}
      location: ${{ parameters.location }}
      serviceConnection: ${{ parameters.serviceConnection }}
      terraformInitSubscription: ${{ variables.tfInitSub }}
      product: ${{ variables.product }}
      terraformVarFile: "$(System.DefaultWorkingDirectory)/$(buildRepoSuffix)/environments/${{ parameters.stack }}/${{ parameters.environment }}.tfvars"
      initCommandOptions: >
        -backend-config resource_group_name=${{ variables.backendAzureRmResourceGroupName }}
      destroyCommandOptions: >
        -var project=${{ variables.project }}
        -var environment=${{ parameters.environment }}
        -var control_vault=$(controlKeyVault) ${{ parameters.targetCommand }}
